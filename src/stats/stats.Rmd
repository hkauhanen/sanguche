---
title: "Contact helps dispreferred combinations of typological features to survive: geospatial evidence"
subtitle: "Statistical analyses"
output: html_document
params:
  dataset: null
---


# Preliminaries

```{r}
# required packages
require(tidyverse)
require(reshape2)
require(broom)
require(pixiedust)
require(emmeans)
source("pvalString_demo.R")

# create results/tables, if it doesn't exist already
try(dir.create("../../results/tables", recursive=TRUE))

# load data
dataset <- params$dataset
data <- read.csv(paste0("../../results/", dataset, "/results_combined.csv"))

# make "control" the reference level of "status" factor
data$status <- factor(data$status)
data$status <- relevel(data$status, ref="non-interacting")
```

# Descriptive statistics

Mean sample size:

```{r}
round(mean(data$N))
```
This suggests the following neighbourhood size to use:

```{r}
neisize = round(sqrt(round(mean(data$N))))
neisize
```

Restrict to this size:

```{r}
data <- data[data$degree == neisize, ]
#data <- data[data$degree == 10, ]
```


# Basic model: comparison of $\Delta$ between typologies of different statuses

```{r}
#datah <- data[data$status != "unknown", ]

datah <- melt(data, id.vars=c("pair", "status", "abs_corrected_phi"), measure.vars=c("Delta_over", "Delta_under"))

mod <- lm(value ~ variable*status, datah)

emm <- emmeans(mod, specs = pairwise ~ variable:status)
con <- as.data.frame(emm$contrasts)
eff <- as.data.frame(eff_size(emm, sigma=sigma(mod), edf=mod$df, method="identity"))

print(con)
print(eff)

print(-con[con$contrast == "(Delta_under non-interacting) - Delta_under interacting", ]$estimate)
print(con[con$contrast == "(Delta_under non-interacting) - Delta_under interacting", ]$p.value)
print(-eff[eff$contrast == "((Delta_under non-interacting) - Delta_under interacting)", ]$effect.size)

print(-con[con$contrast == "(Delta_over non-interacting) - Delta_over interacting", ]$estimate)
print(con[con$contrast == "(Delta_over non-interacting) - Delta_over interacting", ]$p.value)
print(-eff[eff$contrast == "((Delta_over non-interacting) - Delta_over interacting)", ]$effect.size)
```


# Model 2: continuous predictor

```{r}
datah <- melt(data, id.vars=c("pair", "status", "abs_corrected_phi"), measure.vars=c("Delta_over", "Delta_under"))
datah <- datah[datah$status != "non-interacting", ]

mod1_under_w <- lm(value ~ variable * abs_corrected_phi, data=datah)

#mod1_under_w %>% 
#  dust %>% 
#  sprinkle(round=3) %>% 
#  sprinkle(cols="term", replace=c("intercept", "|Ï†_c|", "TAS")) %>% 
#  sprinkle(cols="p.value", fn = quote(pvalString_demo(value, stars=TRUE))) %>%
#  write.table(file=paste0("../../results/tables/mod1_cts_under_", dataset, ".csv"), 
#              row.names=FALSE, col.names=FALSE, sep=",", quote=FALSE)

print(summary(mod1_under_w))
```

