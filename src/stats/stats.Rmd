---
title: "Contact helps dispreferred combinations of typological features to survive: geospatial evidence"
subtitle: "Statistical analyses"
output:
  html_document:
    toc: true
---


# Preliminaries

Packages etc:

```{r}
# required packages
require(tidyverse)
require(reshape2)
require(broom)
require(pixiedust)
require(emmeans)
require(stringr)
require(ggplot2)
require(gridExtra)
require(ggsci)
require(ggsignif)
source("pvalString_demo.R")
source("kloop.R")

# create results/tables, if it doesn't exist already
try(dir.create("../../results/tables", recursive=TRUE))
```

Theme:

```{r}
# default theme
  deftheme <- function() {
    g <- theme_bw()
    #  g <- g + theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank())
    g <- g + theme(panel.grid.minor=element_blank())
    g <- g + theme(axis.text=element_text(color="black"))
    g <- g + theme(strip.text=element_text(size=11), strip.background=element_blank())
    #g <- g + theme(strip.text=element_text(size=12, hjust=0), strip.background=element_blank()  )
    g <- g + theme(text=element_text(family="Times"))
    g
  }
```

Prepare data:

```{r}
prep_data <- function(dataset) {
	# load data
	data <- read.csv(paste0("../../results/", dataset, "/results_combined.csv"))

	# rename "non-interacting" as "control"
	data$status <- ifelse(data$status == "non-interacting", "control", data$status)
	data$status <- factor(data$status)
	data$status <- relevel(data$status, ref="control")

	# return
	data
} 

wals <- prep_data("wals")
gram <- prep_data("grambank")
```

# Descriptive statistics

Mean sample sizes:

```{r}
round(mean(wals$N))
round(mean(gram$N))
```

This suggests the following neighbourhood sizes to use, on average:

```{r}
neisize_wals = round(sqrt(round(mean(wals$N))))
neisize_gram = round(sqrt(round(mean(gram$N))))

neisize_wals
neisize_gram
```

Restrict neighbourhoods by sample sizes per individual feature. Also make a smaller-neighbourhoods version of Grambank:

```{r}
fullwals <- wals
fullgram <- gram

wals <- wals %>% group_by(pair) %>% filter(degree == round(sqrt(N)))
gram <- gram %>% group_by(pair) %>% filter(degree == round(sqrt(N)))

gram_smol <- prep_data("grambank")
kless <- -30
gram_smol <- gram_smol %>% group_by(pair) %>% filter(degree == round(sqrt(N)) + kless)
```


# Basic model: comparison of $\Delta$ between typologies of different statuses

```{r}
basic_model <- function(data) {
	data$overattested <- data$Delta_over
	data$underattested <- data$Delta_under

	datah <- melt(data, id.vars=c("pair", "status", "abs_corrected_phi"), measure.vars=c("overattested", "underattested"))
	mod <- lm(value ~ variable*status, datah)
	
	emm <- emmeans(mod, specs = pairwise ~ variable:status)
	con <- as.data.frame(emm$contrasts)
	eff <- as.data.frame(eff_size(emm, sigma=sigma(mod), edf=mod$df, method="identity"))

	list(mod=mod, con=con, eff=eff)
}

mod_wals <- basic_model(wals)
mod_gram <- basic_model(gram)
mod_gram_smol <- basic_model(gram_smol)
```

## WALS results

```{r}
print(mod_wals$con)
print(mod_wals$eff)
```

## Grambank results

```{r}
print(mod_gram$con)
print(mod_gram$eff)
```

## Grambank (k=10) results

```{r}
print(mod_gram_smol$con)
print(mod_gram_smol$eff)
```

## Nice tables for paper

```{r}
mods = list(mod_wals, mod_gram, mod_gram_smol)
names = list("wals", "grambank", "grambank_smol")

write_con <- function(mod, dataset) {
	#mod$con %>% dust %>% sprinkle(cols=c("estimate", "SE", "t.ratio"), round=4) %>% sprinkle(cols="p.value", fn=quote(pvalString_demo(value, stars=TRUE))) %>% write.table(file=paste0("../../results/tables/mod1_con_", dataset, ".csv"), row.names=FALSE, col.names=FALSE, sep=",", quote=FALSE)
	mod$con %>% subset(select=c("contrast", "estimate", "p.value")) %>% dust %>% sprinkle(cols=c("estimate", "SE", "t.ratio"), round=4) %>% sprinkle(cols="p.value", fn=quote(pvalString_demo(value, stars=TRUE))) %>% write.table(file=paste0("../../results/tables/mod1_con_", dataset, ".csv"), row.names=FALSE, col.names=FALSE, sep=",", quote=FALSE)
}

write_eff <- function(mod, dataset) {
	#mod$eff %>% dust %>% sprinkle(cols=c("effect.size", "SE", "lower.CL", "upper.CL"), round=3) %>% sprinkle(cols="p.value", fn=quote(pvalString_demo(value, stars=TRUE))) %>% write.table(file=paste0("../../results/tables/mod1_eff_", dataset, ".csv"), row.names=FALSE, col.names=FALSE, sep=",", quote=FALSE)
	mod$eff %>% subset(select=c("contrast", "effect.size", "lower.CL", "upper.CL")) %>% dust %>% sprinkle(cols=c("effect.size", "SE", "lower.CL", "upper.CL"), round=3) %>% sprinkle(cols="p.value", fn=quote(pvalString_demo(value, stars=TRUE))) %>% write.table(file=paste0("../../results/tables/mod1_eff_", dataset, ".csv"), row.names=FALSE, col.names=FALSE, sep=",", quote=FALSE)
}

write_combined <- function(mod, dataset) {
	df <- mod$con
	df$cohens.d <- mod$eff$effect.size
	df %>% subset(select=c("contrast", "estimate", "cohens.d", "p.value")) %>% dust %>% sprinkle(cols=c("estimate", "cohens.d"), round=4) %>% sprinkle(cols="p.value", fn=quote(pvalString_demo(value, stars=TRUE))) %>% write.table(file=paste0("../../results/tables/mod1_combined_", dataset, ".csv"), row.names=FALSE, col.names=FALSE, sep=",", quote=FALSE)
}

write_combined_concise <- function(mod, dataset) {
	df <- mod$con
	df$cohens.d <- mod$eff$effect.size

	df <- df[str_count(df$contrast, "underattested") == 2 | str_count(df$contrast, "overattested") == 2, ]
	df <- df[c(3,4,6,1,2,5), ]
	df %>% subset(select=c("contrast", "estimate", "cohens.d", "p.value")) %>% dust %>% sprinkle(cols=c("estimate", "cohens.d"), round=4) %>% sprinkle(cols="p.value", fn=quote(pvalString_demo(value, stars=TRUE))) %>% write.table(file=paste0("../../results/tables/mod1_combined_concise_", dataset, ".csv"), row.names=FALSE, col.names=FALSE, sep=",", quote=FALSE)
}

for (i in 1:3) {
	write_con(mods[[i]], names[[i]])
	write_eff(mods[[i]], names[[i]])
	write_combined(mods[[i]], names[[i]])
	write_combined_concise(mods[[i]], names[[i]])
}
```

## Make plot

```{r}
wals$dataset <- "WALS"
gram$dataset <- "Grambank"
gram_smol$dataset <- "Grambank SN"

all <- rbind(wals, gram, gram_smol)

g1 <- ggplot(all, aes(x=dataset, y=Delta_under, fill=status)) + geom_boxplot(outlier.size=1.0) + ggtitle("Underrepresented types") + xlab("") + ylab("Neighbourhood entropy differential") + scale_fill_npg(name="Typology", guide="none") + theme_bw() + theme(axis.text.x=element_text(color="black", size=10), axis.text.y=element_text(color="black")) + ylim(-0.10, 0.15) + theme(text=element_text(family="serif"))
g2 <- ggplot(all, aes(x=dataset, y=Delta_over, fill=status)) + geom_boxplot(outlier.size=1.0) + ggtitle("Overrepresented types") + xlab("") + ylab("") + scale_fill_npg(name="Typology") + theme_bw() + theme(axis.text.x=element_text(color="black", size=10), axis.text.y=element_text(color="black")) + ylim(-0.10, 0.15) + theme(text=element_text(family="serif"))

g <- grid.arrange(g1, g2, nrow=1, widths=c(0.77, 1.0))
```

Save plot:

```{r}
ggsave(filename="../../results/plots/boxplot_alt.png", plot=g, device="png", units="px", width=3000, height=1500, dpi=350)
```


New boxplot:

```{r}
all$overattested <- all$Delta_over
all$underattested <- all$Delta_under
all <- melt(all, measure.vars=c("underattested", "overattested"))
all$dataset <- factor(all$dataset, levels=c("WALS", "Grambank", "Grambank SN"))

g <- ggplot(all, aes(x=status, y=value, fill=status)) + geom_boxplot(outlier.size=0.75) + facet_wrap(variable~dataset, nrow=1) + geom_signif(comparisons = list(c("control", "interacting")), map_signif_level=TRUE, family="Times", y_position=0.12, size=0.3) + ylab("Neighborhood entropy differential") + xlab("Typology status") + deftheme() + theme(axis.text.x=element_text(angle=35, size=10, hjust=1)) + guides(fill=FALSE) + scale_fill_npg()

png(filename="../../results/plots/boxplot.png", width=3000, height=2000, res=400)
g
dev.off()
```


## k sweeps

```{r}
klo_wals <- kloop(fullwals, "underattested", ks=-23:110)
klo_gram <- kloop(fullgram, "underattested", ks=-39:40)

klo_wals$dataset <- "WALS"
klo_gram$dataset <- "Grambank"

klo <- rbind(klo_wals, klo_gram)

klo <- klo[, c("k", "dataset", "effect.size", "pvalue")]
```

Plots:

```{r}
g1 <- ggplot(klo[klo$dataset == "WALS", ], aes(x=k, y=effect.size)) + geom_line() + xlab("Nudge to neighbourhood size (ℓ)") + ylab(expression("Effect size ("*italic(d)*")")) + deftheme() + ylim(-2.5, 0.5)
g2 <- ggplot(klo[klo$dataset == "WALS", ], aes(x=k, y=pvalue)) + geom_line() + xlab("Nudge to neighbourhood size (ℓ)") + ylab(expression(italic(p)*"-value")) + scale_y_log10() + deftheme() + annotation_logticks(sides="l")

g
png(filename="../../results/plots/ksweep_WALS.png", width=3000, height=1500, res=400)
grid.arrange(g1, g2, nrow=1)
dev.off()


g1 <- ggplot(klo[klo$dataset == "Grambank", ], aes(x=k, y=effect.size)) + geom_line() + xlab("Nudge to neighbourhood size (ℓ)") + ylab(expression("Effect size ("*italic(d)*")")) + deftheme() + ylim(-2.5, 0.5)
g2 <- ggplot(klo[klo$dataset == "Grambank", ], aes(x=k, y=pvalue)) + geom_line() + xlab("Nudge to neighbourhood size (ℓ)") + ylab(expression(italic(p)*"-value")) + scale_y_log10() + deftheme() + annotation_logticks(sides="l")

g <- grid.arrange(g1, g2, nrow=1)
g
png(filename="../../results/plots/ksweep_Grambank.png", width=3000, height=1500, res=400)
grid.arrange(g1, g2, nrow=1)
dev.off()
```


## $\phi$ comparison

```{r}
comp <- merge(wals, gram, by="pair_ID")

g1 <- ggplot(comp, aes(x=abs_phi.x, y=abs_phi.y)) + geom_point() + geom_smooth(method=lm) + xlab("WALS") + ylab("Grambank") + xlim(0,1) + ylim(0,1) + ggtitle(expression("Plain correlation coefficient"~phi)) + deftheme()
g2 <- ggplot(comp, aes(x=abs_corrected_phi.x, y=abs_corrected_phi.y)) + geom_point() + geom_smooth(method=lm) + xlab("WALS") + ylab("Grambank") + xlim(0,1) + ylim(0,1) + ggtitle(expression("Corrected correlation coefficient"~phi[c])) + deftheme()

png(filename="../../results/plots/grambankwals.png", width=3000, height=1600, res=400)
grid.arrange(g1, g2, nrow=1)
dev.off()
```

